# Database Migrations with Alembic

This guide explains how to use Alembic for database migrations in the DocuAI project.

## üîß Setup

The project uses Alembic with async SQLAlchemy and pgvector support. Key files:

- `alembic.ini`: Base configuration file
- `migrations/env.py`: Migration environment configuration
- `migrations/versions/`: Directory containing migration scripts

## üöÄ Common Commands

All Alembic commands should be run using `uv` to ensure consistent environment:

```bash
# Create a new migration
uv run alembic revision --autogenerate -m "description of changes"

# Run all pending migrations
uv run alembic upgrade head

# Rollback last migration
uv run alembic downgrade -1

# Get current migration status
uv run alembic current

# Show migration history
uv run alembic history --verbose
```

## üìÅ Project Configuration

### Environment Setup (env.py)

The project's `env.py` includes several customizations:

1. **Async Support**: Uses `create_async_engine` for async database operations
2. **Project Path**: Adds project root to `sys.path` for imports
3. **Naming Convention**: Consistent constraint/index naming
4. **pgvector Support**: Handles vector type columns properly

### Migration Features

The initial migration (`252cc20ba730_create_initial_tables.py`) demonstrates:

1. **Table Creation**: Three main tables:
   - `data_sources`: Documentation source tracking
   - `documents`: Individual documentation pages
   - `document_chunks`: Text chunks with vector embeddings

2. **Vector Support**:
   ```python
   sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536))
   ```

3. **HNSW Indexing**:
   ```python
   op.create_index(
       'ix_document_chunks_embedding',
       'document_chunks',
       ['embedding'],
       postgresql_using='hnsw',
       postgresql_with={'m': 16, 'ef_construction': 64},
       postgresql_ops={'embedding': 'vector_cosine_ops'}
   )
   ```

## üîÑ Best Practices

1. **Always Review Autogenerated Migrations**:
   - Check for correct table dependencies
   - Verify index and constraint names
   - Ensure vector operations are properly captured

2. **Testing Migrations**:
   - Test both upgrade and downgrade paths
   - Verify on a test database first
   - Check vector indexes work as expected

3. **Handling Vector Operations**:
   - Always specify vector dimensions explicitly
   - Use appropriate index types (HNSW, IVFFlat)
   - Consider performance implications of index parameters

4. **Common Issues**:
   - If vector columns are missed in autogeneration, import `Vector` type explicitly
   - HNSW index creation might need elevated privileges
   - Large vector dimensions might require increased work_mem

## üõ†Ô∏è Troubleshooting

1. **Missing Tables/Columns**:
   - Ensure models are imported in `env.py`
   - Check `target_metadata` configuration
   - Verify table class inherits from Base

2. **Vector-Related Issues**:
   - Confirm pgvector extension is installed
   - Check vector dimension matches model
   - Verify HNSW index parameters

3. **Async Operation Errors**:
   - Use `asyncio.run()` for migration execution
   - Ensure proper async session handling
   - Check database URL format (should start with `postgresql+asyncpg://`)

## üìù Migration Guidelines

1. **Creating New Migrations**:
   ```bash
   # Make changes to SQLAlchemy models
   # Generate migration
   uv run alembic revision --autogenerate -m "descriptive_name"
   # Review generated migration
   # Apply migration
   uv run alembic upgrade head
   ```

2. **Emergency Rollback**:
   ```bash
   # Rollback last migration
   uv run alembic downgrade -1
   # Rollback to specific version
   uv run alembic downgrade <version_id>
   ```

3. **Checking Status**:
   ```bash
   # View current state
   uv run alembic current
   # View history
   uv run alembic history --verbose
   ```

## üîç Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Async Documentation](https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html)
- [pgvector Documentation](https://github.com/pgvector/pgvector) 